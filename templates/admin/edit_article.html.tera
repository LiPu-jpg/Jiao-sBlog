{% extends "admin_base" %}

{% block title %}ç¼–è¾‘æ–‡ç« {% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“ ç¼–è¾‘æ–‡ç« </h2>
    
    <form action="/admin/articles/{{ article.id }}" method="post" style="max-width: 800px;">

        <!-- æ ‡é¢˜ -->
        <div class="form-group">
            <label for="title">ğŸ“„ æ–‡ç« æ ‡é¢˜</label>
            <input type="text" id="title" name="title"
                   value="{{ article.title }}"
                   required
                   style="font-size:1.1rem;padding:15px;">
        </div>

        <!-- Markdown å†…å®¹ -->
        <div class="form-group">
            <label for="content_md">âœï¸ æ–‡ç« å†…å®¹ (Markdown)</label>
            <textarea id="content_md" name="content_md" required
                      style="min-height:400px;font-family:monospace;line-height:1.6;">
{{ article.content_md }}
            </textarea>
        </div>

        <!-- æ ‡ç­¾ -->
        <div class="form-group">
            <label for="tags">ğŸ·ï¸ é€‰æ‹©æ ‡ç­¾</label>
            <div style="margin-bottom:10px;color:var(--text-secondary);font-size:0.9rem;">
                ç‚¹å‡»æ ‡ç­¾å–æ¶ˆé€‰æ‹©ï¼Œæˆ–åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©
            </div>

            <!-- å·²é€‰æ˜¾ç¤º -->
            <div id="tag-container"
                 style="border:2px solid var(--border-color);padding:10px;min-height:50px;border-radius:8px;cursor:text;margin-bottom:10px;background:white;">
            </div>

            <!-- è¾“å…¥æ·»åŠ  -->
            <input type="text" id="tag-input"
                   placeholder="è¾“å…¥æ ‡ç­¾ååæŒ‰å›è½¦æ·»åŠ "
                   style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:8px;margin-bottom:10px;">

            <!-- ä¸‹æ‹‰æ¡† å¿…é¡»åŠ  name -->
            <select id="tag-select" name="tag_ids" multiple
                    style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:8px;">
                {% for tag in tags %}
                <option value="{{ tag.id }}"
                        {% if tag.id in article.tag_ids %}selected{% endif %}>
                    {{ tag.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- æŒ‰é’® -->
        <div style="display:flex;gap:15px;margin-top:30px;">
            <button type="submit" class="btn"
                style="background:var(--secondary-color);padding:12px 30px;font-size:16px;">
                ğŸ’¾ æ›´æ–°æ–‡ç« 
            </button>

            <a href="/admin/articles" class="btn"
               style="background:var(--text-secondary);padding:12px 30px;font-size:16px;text-decoration:none;">
                âŒ å–æ¶ˆ
            </a>
        </div>
    </form>
</div>

<script>
// DOM
const tagContainer = document.getElementById('tag-container');
const tagSelect    = document.getElementById('tag-select');
const tagInput     = document.getElementById('tag-input');

// æ¸²æŸ“å·²é€‰æ ‡ç­¾
function renderTags() {
    tagContainer.innerHTML = '';

    Array.from(tagSelect.options).forEach(opt => {
        if (!opt.selected) return;

        const span = document.createElement('span');
        span.textContent = opt.text;

        span.style.cssText =
            'display:inline-block;background:var(--secondary-color);color:white;' +
            'padding:6px 12px;margin:4px;border-radius:20px;cursor:pointer;' +
            'font-size:0.9rem;transition:var(--transition);';

        // ç‚¹å‡»å–æ¶ˆ
        span.onclick = () => {
            opt.selected = false;
            renderTags();
        };

        tagContainer.appendChild(span);
    });
}

// è¾“å…¥å›è½¦é€‰æ‹©
tagInput.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;

    e.preventDefault();

    const val = tagInput.value.trim();
    if (!val) return;

    const opt = Array.from(tagSelect.options)
        .find(o => o.text.toLowerCase() === val.toLowerCase());

    if (!opt) {
        alert(`æœªæ‰¾åˆ°æ ‡ç­¾ "${val}"`);
        return;
    }

    opt.selected = true;
    tagInput.value = '';
    renderTags();
});

// ç‚¹å‡»å·²é€‰åŒºåŸŸèšç„¦è¾“å…¥
tagContainer.onclick = () => tagInput.focus();

// ä¸‹æ‹‰é€‰æ‹©è§¦å‘æ›´æ–°
tagSelect.onchange = renderTags;

// åˆå§‹æ¸²æŸ“
renderTags();

</script>
{% endblock %}
