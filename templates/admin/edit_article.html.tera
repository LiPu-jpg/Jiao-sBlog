{% extends "admin_base" %}

{% block title %}ç¼–è¾‘æ–‡ç« {% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“ ç¼–è¾‘æ–‡ç« </h2>
    
    <form action="/admin/articles/{{ article.id }}" method="post" style="max-width: 800px;">
        <div class="form-group">
            <label for="title">ğŸ“„ æ–‡ç« æ ‡é¢˜</label>
            <input type="text" id="title" name="title" value="{{ article.title }}" required 
                   placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" style="font-size: 1.1rem; padding: 15px;">
        </div>

        <div class="form-group">
            <label for="content_md">âœï¸ æ–‡ç« å†…å®¹ (Markdownæ ¼å¼)</label>
            <textarea id="content_md" name="content_md" required 
                      placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹ï¼Œæ”¯æŒMarkdownæ ¼å¼"
                      style="min-height: 400px; font-family: 'Courier New', monospace; line-height: 1.6;">{{ article.content_md }}</textarea>
        </div>

        <div class="form-group">
            <label for="tags">ğŸ·ï¸ é€‰æ‹©æ ‡ç­¾</label>
            <div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                ç‚¹å‡»æ ‡ç­¾å¯ä»¥å–æ¶ˆé€‰æ‹©ï¼Œæˆ–åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©
            </div>
            <div id="tag-container" style="border: 2px solid var(--border-color); padding: 10px; min-height: 50px; border-radius: 8px; cursor: text; margin-bottom: 10px; background: white;">
                <!-- å·²é€‰æ ‡ç­¾ -->
            </div>
            <input type="text" id="tag-input" placeholder="è¾“å…¥æ ‡ç­¾ååæŒ‰å›è½¦æ·»åŠ " 
                   style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 10px;">
            <select id="tag-select" multiple style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; display: block;">
                {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if tag.id in article.tag_ids %} selected {% endif %}>
                        {{ tag.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" class="btn" style="background: var(--secondary-color); padding: 12px 30px; font-size: 16px;">
                ğŸ’¾ æ›´æ–°æ–‡ç« 
            </button>
            <a href="/admin/articles" class="btn" style="background: var(--text-secondary); padding: 12px 30px; font-size: 16px; text-decoration: none;">
                âŒ å–æ¶ˆ
            </a>
        </div>
    </form>
</div>

<script>
const tagContainer = document.getElementById('tag-container');
const tagSelect = document.getElementById('tag-select');
const tagInput = document.getElementById('tag-input');

// åˆå§‹åŒ–æ˜¾ç¤ºå·²é€‰æ ‡ç­¾
function renderTags() {
    tagContainer.innerHTML = '';
    Array.from(tagSelect.options).forEach(opt => {
        if (opt.selected) {
            const span = document.createElement('span');
            span.textContent = opt.text;
            span.dataset.value = opt.value;
            span.style.cssText = 'display:inline-block;background:var(--secondary-color);color:white;padding:6px 12px;margin:4px;border-radius:20px;cursor:pointer;font-size:0.9rem;transition:var(--transition);';
            // ç‚¹å‡»å–æ¶ˆé€‰æ‹©
            span.addEventListener('click', () => {
                opt.selected = false;
                renderTags();
            });
            tagContainer.appendChild(span);
        }
    });
}

// è¾“å…¥å›è½¦é€‰æ‹©æ ‡ç­¾
tagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const val = tagInput.value.trim().toLowerCase();
        if (!val) return;

        // æŸ¥æ‰¾å¯¹åº” option
        const opt = Array.from(tagSelect.options).find(o => o.text.toLowerCase() === val);
        if (opt) {
            opt.selected = true;
            renderTags();
            tagInput.value = '';
        } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæç¤ºç”¨æˆ·
            alert(`æœªæ‰¾åˆ°æ ‡ç­¾ "${val}"ï¼Œè¯·ä»ç°æœ‰æ ‡ç­¾ä¸­é€‰æ‹©æˆ–å…ˆåˆ›å»ºæ–°æ ‡ç­¾`);
        }
    }
});

// ç‚¹å‡»å®¹å™¨èšç„¦è¾“å…¥æ¡†
tagContainer.addEventListener('click', () => tagInput.focus());

// ä¸‹æ‹‰æ¡†å˜åŒ–æ—¶æ›´æ–°æ˜¾ç¤º
tagSelect.addEventListener('change', renderTags);

// åˆå§‹åŒ–æ¸²æŸ“
renderTags();

// è¡¨å•æäº¤å‰ç¡®ä¿é€‰æ‹©äº†æ ‡ç­¾
form.addEventListener('submit', (e) => {
    const selectedTags = Array.from(tagSelect.options).filter(opt => opt.selected);
    if (selectedTags.length === 0) {
        if (!confirm('æ‚¨æ²¡æœ‰é€‰æ‹©ä»»ä½•æ ‡ç­¾ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}